generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  shoppingLists   ShoppingList[]      @relation("ListOwner")
  sharedLists     ShoppingListShare[]
  listItems       Item[]
  createdProducts Product[]           @relation("ProductCreator")
  createdArticles Article[]           @relation("ArticleCreator")
  createdStores   Store[]             @relation("StoreCreator")
  createdRecipes  Recipe[]            @relation("RecipeCreator")

  @@index([email])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  isGeneral   Boolean  @default(false) // false = particular, true = general
  createdById String?
  createdBy   User?    @relation("ProductCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  articles     Article[]
  ingredients  ProductIngredient[]
  asIngredient Ingredient?
  recipeIngredients RecipeIngredient[]

  @@index([name])
  @@index([isGeneral, createdById])
}

model Ingredient {
  id           String   @id @default(cuid())
  name         String
  type         String   @default("generic") // "chemical", "generic", "product"
  description  String?
  allergenInfo String?
  productId    String?  @unique // Si type = "product", referencia al producto
  product      Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  products ProductIngredient[]
  articles ArticleIngredient[]

  @@index([name])
  @@index([type])
}

model ProductIngredient {
  id           String     @id @default(cuid())
  productId    String
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  isOptional   Boolean    @default(false)
  createdAt    DateTime   @default(now())

  @@unique([productId, ingredientId])
  @@index([productId])
  @@index([ingredientId])
}

model Article {
  id             String   @id @default(cuid())
  name           String
  description    String?
  productId      String
  product        Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  brand          String   @default("genérico") // Siempre tiene marca, por defecto "genérico"
  variant        String? // Variedad específica (ej: "5L", "integral")
  weightInGrams  Float?   // Peso del producto contenido en gramos (ej: 500 para 500g)
  suggestedPrice Float?
  isGeneral      Boolean  @default(false) // false = particular, true = general
  createdById    String?
  createdBy      User?    @relation("ArticleCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relaciones
  items              Item[]
  stores             ArticleStore[]
  ingredients        ArticleIngredient[]
  recipeIngredients  RecipeIngredient[]

  @@index([name])
  @@index([productId])
  @@index([brand])
  @@index([isGeneral, createdById])
}

model ArticleIngredient {
  id           String     @id @default(cuid())
  articleId    String
  article      Article    @relation(fields: [articleId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  isOptional   Boolean    @default(false)
  createdAt    DateTime   @default(now())

  @@unique([articleId, ingredientId])
  @@index([articleId])
  @@index([ingredientId])
}

model Store {
  id          String   @id @default(cuid())
  name        String
  type        String   @default("other") // "supermarket", "specialty", "online", "other"
  address     String?
  isGeneral   Boolean  @default(false) // false = particular, true = general
  createdById String?
  createdBy   User?    @relation("StoreCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  articles ArticleStore[]
  items    Item[]

  @@index([name])
  @@index([isGeneral, createdById])
}

model ArticleStore {
  id            String    @id @default(cuid())
  articleId     String
  article       Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  storeId       String
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  price         Float?
  available     Boolean   @default(true)
  lastCheckedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([articleId, storeId])
  @@index([articleId])
  @@index([storeId])
}

model ShoppingList {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  owner       User     @relation("ListOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  status      String   @default("draft") // "draft", "active", "completed", "archived"
  statusDate  DateTime @default(now())
  totalCost   Float?
  isTemplate  Boolean  @default(false)
  templateId  String? // Si fue creada desde plantilla
  recipeId    String? // Si fue creada desde una receta
  recipe      Recipe?  @relation(fields: [recipeId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  items  Item[]
  shares ShoppingListShare[]

  @@index([ownerId])
  @@index([status])
  @@index([isTemplate])
  @@index([recipeId])
}

model Item {
  id                String       @id @default(cuid())
  shoppingListId    String
  shoppingList      ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  articleId         String
  article           Article      @relation(fields: [articleId], references: [id], onDelete: Restrict)
  quantity          Float
  unit              String?  // Temporal: se eliminará después de migración
  unitId            String?
  unitRelation      Unit?    @relation("ItemUnit", fields: [unitId], references: [id], onDelete: Restrict)
  purchasedQuantity Float?
  price             Float? // Precio de compra real
  checked           Boolean      @default(false)
  storeId           String?
  store             Store?       @relation(fields: [storeId], references: [id], onDelete: SetNull)
  notes             String?
  addedById         String?
  addedBy           User?        @relation(fields: [addedById], references: [id], onDelete: SetNull)
  purchasedAt       DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@unique([shoppingListId, articleId]) // Un artículo solo puede aparecer una vez por lista
  @@index([shoppingListId])
  @@index([articleId])
  @@index([unitId])
  @@index([checked])
}

model ShoppingListShare {
  id             String       @id @default(cuid())
  shoppingListId String
  shoppingList   ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  canEdit        Boolean      @default(true)
  createdAt      DateTime     @default(now())

  @@unique([shoppingListId, userId])
  @@index([userId])
  @@index([shoppingListId])
}

model Unit {
  id          String   @id @default(cuid())
  name        String   @unique
  symbol      String   // Símbolo de la unidad (ej: "kg", "gr", "un")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  recipeIngredients RecipeIngredient[] @relation("RecipeIngredientUnit")
  items             Item[]             @relation("ItemUnit")

  @@index([name])
  @@index([symbol])
}

model Recipe {
  id              String   @id @default(cuid())
  name            String
  description     String?
  instructions    String?
  servings        Int?
  prepTime        Int?    // minutos
  cookTime        Int?    // minutos
  isGeneral       Boolean  @default(false)
  createdById     String?
  createdBy       User?    @relation("RecipeCreator", fields: [createdById], references: [id], onDelete: SetNull)
  originalRecipeId String?
  originalRecipe  Recipe?  @relation("RecipeCopy", fields: [originalRecipeId], references: [id], onDelete: SetNull)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones
  ingredients     RecipeIngredient[]
  shoppingLists   ShoppingList[]
  copiedRecipes   Recipe[] @relation("RecipeCopy")

  @@index([name])
  @@index([isGeneral, createdById])
  @@index([originalRecipeId])
}

model RecipeIngredient {
  id          String   @id @default(cuid())
  recipeId    String
  recipe      Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  articleId   String?
  article     Article? @relation(fields: [articleId], references: [id], onDelete: SetNull)
  quantity    Float
  unit        String?  // Temporal: se eliminará después de migración
  unitId      String?
  unitRelation Unit?    @relation("RecipeIngredientUnit", fields: [unitId], references: [id], onDelete: Restrict)
  isOptional  Boolean  @default(false)
  notes       String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([recipeId])
  @@index([productId])
  @@index([articleId])
  @@index([unitId])
}
